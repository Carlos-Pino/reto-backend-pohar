-- ===========================================
-- SCRIPT DE ASIGNACIÓN DE TIPO DE GESTIÓN
-- BASE DE DATOS ORACLE
-- ===========================================

-- ===========================================
-- 1. CREAR TABLA EVAL_TIP_GESTION
-- ===========================================
CREATE TABLE EVAL_TIP_GESTION (
    N_ID_TIPO_GESTION NUMBER PRIMARY KEY,
    C_DESCRIPCION VARCHAR2(100),
    N_PESO NUMBER,
    N_ESTADO NUMBER,
    C_USU_REGISTRO VARCHAR2(50),
    D_FEC_REGISTRO DATE
);

-- Insertar registros en EVAL_TIP_GESTION

INSERT INTO EVAL_TIP_GESTION VALUES (3, 'Gestion Visa', 60, 1, 'GNOAIN', TO_DATE('19/11/2018 21:19:00', 'DD/MM/YYYY HH24:MI:SS'));
INSERT INTO EVAL_TIP_GESTION VALUES (4, 'Gestion MC', 50, 1, 'GNOAIN', TO_DATE('19/11/2018 21:19:00', 'DD/MM/YYYY HH24:MI:SS'));
INSERT INTO EVAL_TIP_GESTION VALUES (5, 'Contracargo Visa', 0, 1, 'GNOAIN', TO_DATE('19/11/2018 21:19:00', 'DD/MM/YYYY HH24:MI:SS'));
INSERT INTO EVAL_TIP_GESTION VALUES (6, 'Contracargo MC', 0, 1, 'GNOAIN', TO_DATE('19/11/2018 21:19:00', 'DD/MM/YYYY HH24:MI:SS'));

-- ===========================================
-- 2. CREAR TABLA EVAL_REQ_DETALLE
-- ===========================================
CREATE TABLE EVAL_REQ_DETALLE (
    N_ID_REQ_DETALLE NUMBER PRIMARY KEY,
    N_ID_RQ NUMBER,
    C_COD_AUTORIZACION VARCHAR2(20),
    D_FEC_TRX DATE,
    N_MTO NUMBER,
    C_USU_REGISTRO VARCHAR2(50),
    D_FEC_REGISTRO DATE,
    N_ID_TIPO_GESTION NUMBER,
    D_FEC_GESTION DATE
);

-- Insertar registros de ejemplo en EVAL_REQ_DETALLE

INSERT INTO EVAL_REQ_DETALLE VALUES (1000, 2793862, '080342', TO_DATE('29/05/2024','DD/MM/YYYY'),  14.900, 'SISTEMA', TO_DATE('06/06/2024 01:20:51', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1001, 2793860, '080338', TO_DATE('13/11/2023','DD/MM/YYYY'),  14.900, 'SISTEMA', TO_DATE('06/06/2024 01:21:05', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1002, 2793869, 'T06557', TO_DATE('07/05/2024','DD/MM/YYYY'),  15.000, 'SISTEMA', TO_DATE('06/06/2024 01:21:10', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1003, 2793904, 'T02770', TO_DATE('18/05/2024','DD/MM/YYYY'),  27.800, 'SISTEMA', TO_DATE('06/06/2024 01:21:55', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1004, 2793890, 'T06869', TO_DATE('24/04/2024','DD/MM/YYYY'),  30.900, 'SISTEMA', TO_DATE('06/06/2024 01:21:56', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1005, 2793866, 'T06010', TO_DATE('12/05/2024','DD/MM/YYYY'),  31.900, 'SISTEMA', TO_DATE('06/06/2024 01:15:52', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1006, 2793842, 'T05540', TO_DATE('11/05/2024','DD/MM/YYYY'),  35.000, 'SISTEMA', TO_DATE('06/06/2024 01:16:12', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1007, 2793871, 'T04717', TO_DATE('23/05/2024','DD/MM/YYYY'),  36.500, 'SISTEMA', TO_DATE('06/06/2024 01:20:08', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1008, 2793886, 'T00772', TO_DATE('28/05/2024','DD/MM/YYYY'),  74.200, 'SISTEMA', TO_DATE('06/06/2024 01:20:18', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1009, 2793878, 'T01728', TO_DATE('30/04/2024','DD/MM/YYYY'), 113.850, 'SISTEMA', TO_DATE('06/06/2024 01:21:09', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1010, 2793880, 'Q28185', TO_DATE('28/05/2024','DD/MM/YYYY'), 178.200, 'SISTEMA', TO_DATE('06/06/2024 01:21:19', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1011, 2793891, 'T00330', TO_DATE('22/04/2024','DD/MM/YYYY'), 619.000, 'SISTEMA', TO_DATE('06/06/2024 01:21:56', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);
INSERT INTO EVAL_REQ_DETALLE VALUES (1012, 2793878, '079822', TO_DATE('3/06/2024','DD/MM/YYYY'), 186.960, 'SISTEMA', TO_DATE('06/06/2024 01:22:05', 'DD/MM/YYYY HH24:MI:SS'), NULL, NULL);

-- ===========================================
-- 3. PACKAGE Y PROCEDIMIENTO PARA ASIGNACION
-- ===========================================
CREATE OR REPLACE PACKAGE PKG_EVAL_ASIGNACION AS
    PROCEDURE ASIGNAR_TIPO_GESTION;
END PKG_EVAL_ASIGNACION;
/

CREATE OR REPLACE PACKAGE BODY PKG_EVAL_ASIGNACION AS
    PROCEDURE ASIGNAR_TIPO_GESTION IS
        CURSOR cur_req IS
            SELECT N_ID_REQ_DETALLE, N_MTO
            FROM EVAL_REQ_DETALLE;

        v_tipo_gestion NUMBER;

    BEGIN
        FOR rec IN cur_req LOOP
            IF rec.N_MTO <= 10 THEN
                v_tipo_gestion := 6;
            ELSIF rec.N_MTO > 10 AND rec.N_MTO <= 35 THEN
                v_tipo_gestion := 5;
            ELSIF rec.N_MTO > 35 AND rec.N_MTO <= 100 THEN
                v_tipo_gestion := 4;
            ELSE
                v_tipo_gestion := 3;
            END IF;

            UPDATE EVAL_REQ_DETALLE
            SET N_ID_TIPO_GESTION = v_tipo_gestion,
                D_FEC_GESTION = SYSDATE
            WHERE N_ID_REQ_DETALLE = rec.N_ID_REQ_DETALLE;
        END LOOP;

        COMMIT;
    END ASIGNAR_TIPO_GESTION;
END PKG_EVAL_ASIGNACION;
/

-- ===========================================
-- 4. LLAMAR AL PROCEDIMIENTO PARA PRUEBA
-- ===========================================
BEGIN
    PKG_EVAL_ASIGNACION.ASIGNAR_TIPO_GESTION;
END;
/
